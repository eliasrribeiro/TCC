---
title: "Técnicas de Reamostragem"
output:
  pdf_document: default
  html_document:
    df_print: paged
date: ''
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,warning = FALSE,message=FALSE)
library(tidymodels)
library(janitor)
library(stringr)
library(vip)
library(probably)
library(gt)
library(ggplot2)
library(patchwork)
library(themis)
library(recipes)
library(modeldata)
library(UBL)
library(smotefamily)
library(questionr)
library(viridisLite)
library(viridis)
library(geobr)
library(scales)
library(grid)
library(gridExtra)
library(cowplot)
library(data.table)
library(zoo)
library(summarytools)
library(modelsummary)
library(glmnet)
theme_set(theme_minimal())
```

## Métodos de Downsample

```{r,echo=FALSE,warning=FALSE,message=FALSE}

states <- read_state(year = 2020) #Para gráfico

dataset <- readr::read_csv("srag_16-22.gz") # pego em 17/08/2022


dados <- dataset  %>% #3.511.859
    rename(sexo = CS_SEXO, idade = NU_IDADE_N) %>% 
    filter(as.Date(DT_SIN_PRI,format="%d/%m/%Y") < as.Date("01-12-2021",format="%d-%m-%Y")) %>% #3.041.403
    filter(sexo == "F") %>% # 1.342.879 points
    filter(idade > 9 & idade < 56) %>% # 502.903 points
    mutate(ano = str_sub(DT_SIN_PRI, start = 7)) %>% 
    mutate(classi_gesta_puerp = as.factor(case_when(
      CS_GESTANT == 1 ~ "1tri",
      CS_GESTANT == 2 ~ "2tri",
      CS_GESTANT == 3 ~ "3tri",
      CS_GESTANT == 4 ~ "IG_ig",
      CS_GESTANT == 5 & PUERPERA == 1 ~ "puerp",
      CS_GESTANT == 9 & PUERPERA == 1 ~ "puerp"))
    ) %>% 
    filter(!is.na(classi_gesta_puerp)) # 38.877 points

freq(dados$CLASSI_FIN)

# dados1 <- dados

data <- dados %>% 
    mutate(classi_fin = as.factor(case_when(
      CLASSI_FIN == 1 ~ "Não COVID-19",
      CLASSI_FIN == 2 ~ "Não COVID-19",
      CLASSI_FIN == 3 ~ "Não COVID-19",
      CLASSI_FIN == 5 ~ "COVID-19",
      TRUE ~ NA_character_))
    ) %>% 
    filter(!is.na(classi_fin)) %>%  # 20.619 points
    mutate(raca = as.factor(case_when( # race
      CS_RACA == 1 ~ "branca",
      CS_RACA == 2 | CS_RACA == 3 | CS_RACA == 4 |
        CS_RACA == 5 ~ "não branca",
      CS_RACA == 9 ~ "ignorado",
      TRUE ~ "em branco"))
    ) %>%   
    mutate(escolaridade = as.factor(case_when( # instruction
      # ~ "sem escolaridade",
      CS_ESCOL_N == 0 | CS_ESCOL_N == 1 | CS_ESCOL_N == 2 ~ "até fundamental",
      CS_ESCOL_N == 3 ~ "médio",
      CS_ESCOL_N == 4 ~ "superior",
      CS_ESCOL_N == 9 ~ "ignorado",
      TRUE ~ "em branco"))
    ) %>% 
    mutate(vacina = as.factor(case_when( #vacine
      VACINA == 1  ~ "sim",
      VACINA == 2 ~ "não",
      VACINA == 9 ~ "ignorado",
      TRUE ~ "em branco"))
    ) %>% 
    mutate(febre = as.factor(case_when( # fever
      FEBRE == 1 ~ "sim",
      FEBRE == 2 ~ "não",
      FEBRE == 9 ~ "ignorado",
      TRUE ~ "em branco"))
    ) %>% 
    mutate(tosse = as.factor(case_when( # cough
      TOSSE == 1 ~ "sim",
      TOSSE == 2 ~ "não",
      TOSSE == 9 ~ "ignorado",
      TRUE ~ "em branco"))
    ) %>% 
    mutate(garganta = as.factor(case_when( # throat
      GARGANTA == 1 ~ "sim",
      GARGANTA  == 2 ~ "não",
      GARGANTA == 9 ~ "ignorado",
      TRUE ~ "em branco"))
    ) %>% 
    mutate(dispneia = as.factor(case_when( # dyspnea
      DISPNEIA == 1 ~ "sim",
      DISPNEIA == 2 ~ "não",
      DISPNEIA == 9 ~ "ignorado",
      TRUE ~ "em branco"))
    ) %>%
    mutate(desc_resp = as.factor(case_when( # respiratory distress
      DESC_RESP == 1 ~ "sim",
      DESC_RESP == 2 ~ "não",
      DESC_RESP == 9 ~ "ignorado",
      TRUE ~ "em branco"))
    ) %>%
    mutate(saturacao = as.factor(case_when( # saturation
      SATURACAO == 1 ~ "sim",
      SATURACAO == 2 ~ "não",
      SATURACAO == 9 ~ "ignorado",
      TRUE ~ "em branco"))
    ) %>%
    mutate(diarreia = as.factor(case_when( # diarrhea
      DIARREIA == 1 ~ "sim",
      DIARREIA == 2 ~ "não",
      DIARREIA == 9 ~ "ignorado",
      TRUE ~ "em branco"))
    ) %>% 
    mutate(cardiopatia = as.factor(case_when( # heart disease
      CARDIOPATI == 1 ~ "sim",
      CARDIOPATI == 2 ~ "não",
      CARDIOPATI == 9 ~ "ignorado",
      TRUE ~ "em branco"))
    ) %>%
    mutate(pneumopatia = as.factor(case_when( # lung disease
      PNEUMOPATI == 1 ~ "sim",
      PNEUMOPATI == 2 ~ "não",
      PNEUMOPATI == 9 ~ "ignorado",
      TRUE ~ "em branco"))
    ) %>%
    mutate(renal = as.factor(case_when( # kidney disease
      RENAL == 1 ~ "sim",
      RENAL == 2 ~ "não",
      RENAL == 9 ~ "ignorado",
      TRUE ~ "em branco"))
    ) %>%
    mutate(obesidade = as.factor(case_when( # obesity
      OBESIDADE == 1 ~ "sim",
      OBESIDADE == 2 ~ "não",
      OBESIDADE == 9 ~ "ignorado",
      TRUE ~ "em branco"))
    ) %>%
  mutate(uti = as.factor(case_when(
    UTI == 1 ~ "Sim",
    UTI == 2 ~ "Não",
    UTI == 9 ~ "Ignorado",
    TRUE ~ "Em branco"))
  ) %>%
  mutate(suport_ven = as.factor(case_when(
    SUPORT_VEN == 1 ~ "sim, invasivo",
    SUPORT_VEN == 2 ~ "sim, não invasivo",
    SUPORT_VEN == 3 ~ "não",
    SUPORT_VEN == 9 ~ "ignorado",
    TRUE ~ "em branco"))
  ) %>%
  mutate(evolucao = as.factor(case_when(
    EVOLUCAO == 1 ~ "cura",
    EVOLUCAO == 2 ~ "óbito",
    EVOLUCAO == 3 ~ "óbito",
    EVOLUCAO == 9 ~ "ignorado",
    TRUE ~ "em branco"))
  ) %>% 
  mutate(dt_notific = as.Date(DT_NOTIFIC, format = "%d/%m/%Y"),
         dt_sint = as.Date(DT_SIN_PRI, format = "%d/%m/%Y"),
         dt_interna = as.Date(DT_INTERNA, format = "%d/%m/%Y")
  ) %>% 
  mutate(
    tempo_sintomas_hosp = as.numeric(dt_interna - dt_sint),
    tempo_sintomas_notific = as.numeric(dt_notific - dt_sint)
  ) 


# dados numéricos
data1 <- data %>% 
  select(idade,tempo_sintomas_notific,tempo_sintomas_hosp,classi_fin) 

data3 <- data %>% 
  select(idade,dt_sint,ano,tempo_sintomas_notific,tempo_sintomas_hosp,classi_fin) 

data2 <- data %>%
  select(!where(is.numeric),idade,tempo_sintomas_notific,tempo_sintomas_hosp, -c(ano, DT_SIN_PRI,DT_NOTIFIC,DT_INTERNA,sexo)) 

```

## Casos por estado COVID-19

```{r}
dados4 <- data2 %>%
   select(SG_UF,classi_fin) %>%
   filter(classi_fin == "COVID-19") 

valor <- data.frame(table(dados4$SG_UF))
colnames(valor) <- c("uf", "n")

dt22_state <- valor %>%
   mutate(T2 = (n/sum(n))*100)

states2 <- dplyr::left_join(states, dt22_state, by = c("abbrev_state" = "uf"))

g1 <- ggplot(data = states2)+
  geom_sf(aes(fill = T2), color = "grey30", size = .15) +
  theme_void()  +
  labs(title="COVID-19",subtitle = "(a) Porcentagem de casos de COVID-19 por estado") +
  scale_fill_viridis_c(option = "magma", direction = -1,limits=c(0,26)) + 
  theme(legend.position="none")

```

## Casos por estado não COVID-19

```{r}
dados5 <- data2 %>%
   select(SG_UF,classi_fin) %>%
   filter(classi_fin == "Não COVID-19") 

valor1 <- data.frame(table(dados5$SG_UF))

colnames(valor1) <- c("uf", "n")

dt11_state <- valor1 %>%
   mutate(T2 = (n/sum(n))*100)

states1 <- dplyr::left_join(states, dt11_state, by = c("abbrev_state" = "uf"))

g2 <- ggplot(data= states1) +
  geom_sf(aes(fill=T2), color= "grey30", size=.15) +
  theme_void()  +
  labs(fill = "Casos[%]",title="Não COVID-19",subtitle = "(b) Porcentagem de casos de não COVID-19 por estado") +
  scale_fill_viridis_c(option="magma",direction=-1)

g1|g2 #850x450
```

Casos Covid-19 por data de primeiros sintomas

```{r}
d <- data2 %>% 
  mutate(month_year = paste(formatC(month(dt_sint), width=2, format="d", flag="0"),
                            year(dt_sint),sep="/")) %>% 
  filter(classi_fin=="COVID-19")

freq_mes <- data.table(table(d$month_year))
freq_mes$V1 <- as.yearmon(freq_mes$V1, format = "%m/%Y") 
freq_mes$V3 <- as.Date(format(freq_mes$V1,"%Y-%m-01"))

g3 <- ggplot(data=freq_mes, aes(x = V3, y=N)) + 
  geom_line(size=1.2, color="plum") + 
  geom_point(size=2,color="plum") + 
 xlab("Mês dos primeiros sintomas")  +
    ylab("Número de casos") + scale_x_date(labels = date_format("%h %y"),
               breaks = seq(from = min(freq_mes$V3), 
                            to = max(freq_mes$V3), by = "month")) +
  theme(axis.text.x = element_text(angle = 60, hjust = 1)) + theme_minimal() + 
  theme(axis.text.x = element_text(angle = 60, hjust = 1)) + 
  labs(title="COVID-19",subtitle = ("(a) Casos de COVID-19"))
```

Casos não Covid por data de primeiros sintomas

```{r}
d1 <- data2 %>% 
  mutate(month_year = paste(formatC(month(dt_sint), width=2, format="d", flag="0"),
                            year(dt_sint),sep="/")) %>% 
  filter(classi_fin=="Não COVID-19")

freq_mes <- data.table(table(d1$month_year))
freq_mes$V1 <- as.yearmon(freq_mes$V1, format = "%m/%Y") 
freq_mes$V3 <- as.Date(format(freq_mes$V1,"%Y-%m-01"))

g4 <- ggplot(data=freq_mes, aes(x = V3, y=N)) + 
  geom_line(size=1.2, color="plum") + 
  geom_point(size=2,color="plum") +
 xlab("Mês dos primeiros sintomas") + ylab("Número de Casos") + theme_minimal() + 
  theme(axis.text.x = element_text(angle = 60, hjust = 1)) + 
  labs(title="Não COVID-19",subtitle="(b) Casos de não COVID-19")

g3/g4 #800x750
```

```{r}
media <- function(x)
  mean(x, na.rm = TRUE)
mediana <- function(x)
  median(x, na.rm = TRUE)
DP <- function(x)
  sd(x, na.rm = TRUE)
minimo <- function(x)
  base::min(x, na.rm = TRUE)
maximo <- function(x)
  base::max(x, na.rm = TRUE)
q25 <- function(x)
  stats::quantile(x, p = 0.25, na.rm = TRUE)
q75 <- function(x)
  stats::quantile(x, p = 0.75, na.rm = TRUE)
IQR <- function(x)
  round(q75(x) - q25(x), 2)
n <- function(x)
  sum(!is.na(x))

datasummary1 <- datasummary((classi_fin) ~  idade*(n+media+DP+mediana+q25+q75+IQR),
            data = data1, output = 'markdown')

datasummary2 <- datasummary((classi_fin) ~  tempo_sintomas_notific*(n+media+DP+mediana+q25+q75+IQR),
                 data = data1, output = 'markdown')

t.test(idade~ classi_fin, data = data1)
t.test(tempo_sintomas_notific~ classi_fin, data = data1)

```

## Remonstragem com dados numéricos


### DownSample

```{r,echo=TRUE}
data <- data1 %>% 
  select(idade, tempo_sintomas_notific,classi_fin) %>% 
  drop_na() %>% 
  as.data.frame()

g5 <- ggplot(data, aes(idade, tempo_sintomas_notific,color = classi_fin)) +
  geom_point(alpha=0.5) +
  labs(title = "Dados originais") + ylab("Dias do sintoma até a notificação") +
  scale_colour_viridis_d() + labs(color="Classificação") 

dados3 <- recipe(classi_fin ~ idade + tempo_sintomas_notific, data = data) %>%
  step_downsample(classi_fin,seed=69) %>%
  prep() %>%
  bake(new_data = NULL)

g6 <-  dados3 %>%
  ggplot(aes(idade, tempo_sintomas_notific, color = classi_fin)) +
  geom_point(alpha=0.5) +
  labs(title = "Com Down-sample") + ylab("Dias do sintoma até a notificação") +
  scale_colour_viridis_d() + labs(color="Classificação") + 
  scale_y_continuous(limits = c(0,700))

g5|g6

datasummary((classi_fin) ~  idade*(n+media+DP+mediana+q25+q75+IQR),
            data = dados3, output = 'markdown') 

datasummary((classi_fin) ~  tempo_sintomas_notific*(n+media+DP+mediana+q25+q75+IQR),
            data = dados3, output = 'markdown')
```


### NearMiss

```{r,echo=FALSE}
g7 <- recipe(classi_fin ~ idade + tempo_sintomas_notific, data = data) %>%
  step_nearmiss(classi_fin, seed=69) %>%
  prep() %>%
  bake(new_data = NULL) %>%
  ggplot(aes(idade, tempo_sintomas_notific, color = classi_fin)) +
  geom_point(alpha=0.5) +
  labs(title = "Com Near-miss") + ylab("Dias do sintoma até a notificação") +
  scale_colour_viridis_d() + labs(color="Classificação") +
  scale_y_continuous(limits = c(0,700))


dados3 <- recipe(classi_fin ~ idade + tempo_sintomas_notific, data = data) %>%
  step_nearmiss(classi_fin, seed=69) %>%
  prep() %>%
  bake(new_data = NULL)

datasummary((classi_fin) ~  idade*(n+media+DP+mediana+q25+q75+IQR),
            data = dados3, output = 'markdown') 

datasummary((classi_fin) ~  tempo_sintomas_notific*(n+media+DP+mediana+q25+q75+IQR),
            data = dados3, output = 'markdown')

g5|g7
```


### Links de Tomek

```{r}
set.seed(69)

dado <- TomekClassif(classi_fin ~., data,rem="maj")[[1]]

# g8 <- recipe(classi_fin ~ idade + tempo_sintomas_notific,data = data) %>%
#   step_tomek(classi_fin,seed=69) %>%
#   prep() %>%
#   bake(new_data = NULL) #%>%
  # ggplot(aes(idade, tempo_sintomas_notific, color = classi_fin)) +
  # geom_point(alpha=0.5) +
  # labs(title = "With Tomek")

g8 <- dado %>%
  ggplot(aes(idade, tempo_sintomas_notific, color = classi_fin)) +
  geom_point(alpha=0.5) +
  labs(title = "Com Links de Tomek") + ylab("Dias do sintoma até a notificação") +
  scale_colour_viridis_d() + labs(color="Classificação")


g5|g8

datasummary((classi_fin) ~  idade*(n+media+DP+mediana+q25+q75+IQR),
            data = dado, output = 'markdown') 

datasummary((classi_fin) ~  tempo_sintomas_notific*(n+media+DP+mediana+q25+q75+IQR),
            data = dado, output = 'markdown')
```

## Métodos de Up-Sample

### Upsample

```{r,echo=FALSE}
g9 <- recipe(classi_fin ~ idade + tempo_sintomas_notific, data = data) %>%
  step_upsample(classi_fin,seed=69) %>%
  prep() %>%
  bake(new_data = NULL) %>%
  ggplot(aes(idade, tempo_sintomas_notific, color = classi_fin)) +
  geom_point(alpha=0.5) +
  labs(title = "Com Up-Sample") + ylab("Dias do sintoma até a notificação") +
  scale_colour_viridis_d() + labs(color="Classificação")


dados3 <- recipe(classi_fin ~ idade + tempo_sintomas_notific, data = data) %>%
  step_upsample(classi_fin,seed=69) %>%
  prep() %>%
  bake(new_data = NULL)

datasummary((classi_fin) ~  idade*(n+media+DP+mediana+q25+q75+IQR),
            data = dados3, output = 'markdown') 

datasummary((classi_fin) ~  tempo_sintomas_notific*(n+media+DP+mediana+q25+q75+IQR),
            data = dados3, output = 'markdown')

g5|g9
```


### Smote

```{r,echo=FALSE}
g10 <- recipe(classi_fin ~ idade + tempo_sintomas_notific, data = data) %>%
  step_smote(classi_fin,seed=69) %>%
  prep() %>%
  bake(new_data = NULL) %>%
  ggplot(aes(idade, tempo_sintomas_notific, color = classi_fin)) +
  geom_point(alpha=0.5) +
  labs(title = "Com SMOTE") + ylab("Dias do sintoma até a notificação") +
  scale_colour_viridis_d() + labs(color="Classificação")


dados3 <- recipe(classi_fin ~ idade + tempo_sintomas_notific, data = data) %>%
  step_smote(classi_fin,seed=69) %>%
  prep() %>%
  bake(new_data = NULL)

datasummary((classi_fin) ~  idade*(n+media+DP+mediana+q25+q75+IQR),
            data = dados3, output = 'markdown') 

datasummary((classi_fin) ~  tempo_sintomas_notific*(n+media+DP+mediana+q25+q75+IQR),
            data = dados3, output = 'markdown')

g5|g10
```



### ADASYN 

```{r}
g11 <- recipe(classi_fin ~ idade + tempo_sintomas_notific, data = data) %>%
  step_adasyn(classi_fin,seed=69) %>%
  prep() %>%
  bake(new_data = NULL) %>%
  ggplot(aes(idade, tempo_sintomas_notific, color = classi_fin)) +
  geom_point(alpha=0.5) +
  labs(title = "Com ADASYN") + ylab("Dias do sintoma até a notificação") +
  scale_colour_viridis_d() + labs(color="Classificação")


dados3 <- recipe(classi_fin ~ idade + tempo_sintomas_notific, data = data) %>%
  step_adasyn(classi_fin,seed=69) %>%
  prep() %>%
  bake(new_data = NULL)

datasummary((classi_fin) ~  idade*(n+media+DP+mediana+q25+q75+IQR),
            data = dados3, output = 'markdown') 

datasummary((classi_fin) ~  tempo_sintomas_notific*(n+media+DP+mediana+q25+q75+IQR),
            data = dados3, output = 'markdown')

g5|g11
```

### Borderline Smote

```{r}
g12 <- recipe(classi_fin ~ idade + tempo_sintomas_notific, data = data) %>%
  step_bsmote(classi_fin,all_neighbors = FALSE,seed=69) %>%
  prep() %>%
  bake(new_data = NULL) %>%
  ggplot(aes(idade, tempo_sintomas_notific, color = classi_fin)) +
  geom_point(alpha=0.5) +
  labs(title = "Com  Borderline-SMOTE1") + 
  ylab("Dias do sintoma até a notificação") +
  scale_colour_viridis_d() + labs(color="Classificação")

g13 <- recipe(classi_fin ~ idade + tempo_sintomas_notific, data = data) %>%
  step_bsmote(classi_fin,all_neighbors = TRUE,seed=69) %>%
  prep() %>%
  bake(new_data = NULL) %>%
  ggplot(aes(idade, tempo_sintomas_notific, color = classi_fin)) +
  geom_point(alpha=0.5) +
  labs(title = "Com  Borderline-SMOTE2") + 
  ylab("Dias do sintoma até a notificação") +
  scale_colour_viridis_d() + labs(color="Classificação")

g12|g13

dados3 <- recipe(classi_fin ~ idade + tempo_sintomas_notific, data = data) %>%
  step_bsmote(classi_fin,all_neighbors = TRUE,seed=69) %>%
  prep() %>%
  bake(new_data = NULL)

datasummary((classi_fin) ~  idade*(n+media+DP+mediana+q25+q75+IQR),
            data = dados3, output = 'markdown') 

datasummary((classi_fin) ~  tempo_sintomas_notific*(n+media+DP+mediana+q25+q75+IQR),
            data = dados3, output = 'markdown')
```

### DBSMOTE

```{r,warning=FALSE,message=FALSE,include=FALSE}
set.seed(69)

dado <- DBSMOTE(data %>% select(-classi_fin),data$classi_fin)$data

dado$classi_fin <- as.factor(dado$class)

g14 <- ggplot(dado,aes(idade, tempo_sintomas_notific, color = classi_fin)) +
  geom_point(alpha=0.5) +
  labs(title = "Com  DBSMOTE") + 
  ylab("Dias do sintoma até a notificação") +
  scale_colour_viridis_d() + labs(color="Classificação")
```

```{r}
g5|g14


datasummary((classi_fin) ~  idade*(n+media+DP+mediana+q25+q75+IQR),
            data = dado, output = 'markdown') 

datasummary((classi_fin) ~  tempo_sintomas_notific*(n+media+DP+mediana+q25+q75+IQR),
            data = dado, output = 'markdown')
```


### ROSE 

```{r}
g15 <- recipe(classi_fin ~ idade + tempo_sintomas_notific, data = data) %>%
  step_rose(classi_fin,seed=69) %>%
  prep() %>%
  bake(new_data = NULL) %>%
  ggplot(aes(idade, tempo_sintomas_notific, color = classi_fin)) +
  geom_point(alpha=0.5) +
  labs(title = "Com  ROSE") + 
  ylab("Dias do sintoma até a notificação") +
  scale_colour_viridis_d() + 
  labs(color="Classificação") + scale_y_continuous(limits = c(0,700))

g5|g15

dados3 <- recipe(classi_fin ~ idade + tempo_sintomas_notific, data = data) %>%
  step_rose(classi_fin,seed=69) %>%
  prep() %>%
  bake(new_data = NULL)

datasummary((classi_fin) ~  idade*(n+media+DP+mediana+q25+q75+IQR),
            data = dados3, output = 'markdown') 

datasummary((classi_fin) ~  tempo_sintomas_notific*(n+media+DP+mediana+q25+q75+IQR),
            data = dados3, output = 'markdown')
```


```{r,echo=FALSE,eval=FALSE}
### Junção Gráficos

#### Boderlines

legend <- get_legend(g5)
gg5 <- g5 + theme(legend.position="none") + labs(subtitle = "(a)")
gg12 <- g12 + theme(legend.position="none") + labs(subtitle = "(b)")
gg13 <- g13  + theme(legend.position="none") + labs(subtitle = "(c)")
grid.arrange(gg5 ,gg12,gg13,legend, ncol=4, widths=c(2.3, 2.3,2.3, 1.2)) #900x420


#### Subamostragens


gg5 <- g5 + theme(legend.position="none") + labs(subtitle = "(a)")
gg7 <- g7 + theme(legend.position="none") + labs(subtitle = "(b)")
gg8 <- g8 + theme(legend.position="none") + labs(subtitle = "(c)")
grid.arrange(gg5 ,gg7,gg8,legend, ncol=4, widths=c(2.3, 2.3,2.3, 1.2))  #900x420


#### upsample e downsample

gg6 <- g6 + theme(legend.position="none") + labs(subtitle = "(b)")
gg9 <- g9 + theme(legend.position="none") + labs(subtitle = "(c)")
grid.arrange(gg5 ,gg6,gg9,legend, ncol=4, widths=c(2.3, 2.3,2.3, 1.2))  #900x420


#### Smote


gg10 <- g10 + theme(legend.position="none") + labs(subtitle = "(b)")
grid.arrange(gg5 ,gg10,legend, ncol=3, widths=c(2.3, 2.3, 0.8))  #900x420


#### Adasyn e DBSMOTE

gg11 <- g11 + theme(legend.position="none") + labs(subtitle = "(b)")
gg14 <- g14 + theme(legend.position="none") + labs(subtitle = "(c)")
grid.arrange(gg5 ,gg11,gg14,legend, ncol=4, widths=c(2.3, 2.3,2.3, 1.2))  #900x420


#### Rose

gg15 <- g15 + theme(legend.position="none") + labs(subtitle = "(b)")
grid.arrange(gg5 ,gg15,legend, ncol=3, widths=c(2.3, 2.3, 1.2))  #900x420
```

## Reamostragem com dados numéricos e categóricos com aplicação do modelo logístico

### Dados

```{r}
# Selecting data ------------

data_categorico <- dados %>% 
  mutate(classi_fin = as.factor(case_when(
      CLASSI_FIN == 1 ~ "Não COVID-19",
      CLASSI_FIN == 2 ~ "Não COVID-19",
      CLASSI_FIN == 3 ~ "Não COVID-19",
      CLASSI_FIN == 5 ~ "COVID-19",
      TRUE ~ NA_character_))
    ) %>% 
  filter(!is.na(classi_fin)) %>%# 20.629 points
  mutate(raca = as.factor(case_when( # race
    CS_RACA == 1 ~ "branca",
    CS_RACA == 2 | CS_RACA == 3 | CS_RACA == 4 |
      CS_RACA == 5 ~ "não branca",
    CS_RACA == 9 ~ "ignorado",
    TRUE ~ "em branco"))
  ) %>%   
  mutate(escolaridade = as.factor(case_when( # instruction
    # ~ "sem escolaridade",
    CS_ESCOL_N == 0 | CS_ESCOL_N == 1 | CS_ESCOL_N == 2 ~ "até fundamental",
    CS_ESCOL_N == 3 ~ "médio",
    CS_ESCOL_N == 4 ~ "superior",
    CS_ESCOL_N == 9 ~ "ignorado",
    TRUE ~ "em branco"))
  ) %>% 
  mutate(vacina = as.factor(case_when( #vacine
    VACINA == 1  ~ "sim",
    VACINA == 2 ~ "não",
    VACINA == 9 ~ "ignorado",
    TRUE ~ "em branco"))
  ) %>% 
  mutate(febre = as.factor(case_when( # fever
    FEBRE == 1 ~ "sim",
    FEBRE == 2 ~ "não",
    FEBRE == 9 ~ "ignorado",
    TRUE ~ "em branco"))
  ) %>% 
  mutate(tosse = as.factor(case_when( # cough
    TOSSE == 1 ~ "sim",
    TOSSE == 2 ~ "não",
    TOSSE == 9 ~ "ignorado",
    TRUE ~ "em branco"))
  ) %>% 
  mutate(garganta = as.factor(case_when( # throat
    GARGANTA == 1 ~ "sim",
    GARGANTA  == 2 ~ "não",
    GARGANTA == 9 ~ "ignorado",
    TRUE ~ "em branco"))
  ) %>% 
  mutate(dispneia = as.factor(case_when( # dyspnea
    DISPNEIA == 1 ~ "sim",
    DISPNEIA == 2 ~ "não",
    DISPNEIA == 9 ~ "ignorado",
    TRUE ~ "em branco"))
  ) %>%
  mutate(desc_resp = as.factor(case_when( # respiratory distress
    DESC_RESP == 1 ~ "sim",
    DESC_RESP == 2 ~ "não",
    DESC_RESP == 9 ~ "ignorado",
    TRUE ~ "em branco"))
  ) %>%
  mutate(saturacao = as.factor(case_when( # saturation
    SATURACAO == 1 ~ "sim",
    SATURACAO == 2 ~ "não",
    SATURACAO == 9 ~ "ignorado",
    TRUE ~ "em branco"))
  ) %>%
  mutate(diarreia = as.factor(case_when( # diarrhea
    DIARREIA == 1 ~ "sim",
    DIARREIA == 2 ~ "não",
    DIARREIA == 9 ~ "ignorado",
    TRUE ~ "em branco"))
  ) %>% 
  mutate(cardiopatia = as.factor(case_when( # heart disease
    CARDIOPATI == 1 ~ "sim",
    CARDIOPATI == 2 ~ "não",
    CARDIOPATI == 9 ~ "ignorado",
    TRUE ~ "em branco"))
  ) %>%
  mutate(pneumopatia = as.factor(case_when( # lung disease
    PNEUMOPATI == 1 ~ "sim",
    PNEUMOPATI == 2 ~ "não",
    PNEUMOPATI == 9 ~ "ignorado",
    TRUE ~ "em branco"))
  ) %>%
  mutate(renal = as.factor(case_when( # kidney disease
    RENAL == 1 ~ "sim",
    RENAL == 2 ~ "não",
    RENAL == 9 ~ "ignorado",
    TRUE ~ "em branco"))
  ) %>%
  mutate(obesidade = as.factor(case_when( # obesity
    OBESIDADE == 1 ~ "sim",
    OBESIDADE == 2 ~ "não",
    OBESIDADE == 9 ~ "ignorado",
    TRUE ~ "em branco"))
  ) %>% 
  dplyr::select(!where(is.numeric), idade, -c(ano, DT_SIN_PRI,DT_NOTIFIC,DT_INTERNA,
                                              sexo,SG_UF,classi_gesta_puerp)) %>% # pneumopatia, saturacao, renal, obesidade, desc_resp, dispneia,
  # mutate_if(is.factor, as.numeric) %>% 
  drop_na() 


data_categorico2 <- data_categorico %>% 
  as.data.frame()

data_categorico <- data_categorico %>% 
  as_tibble() 

```

### Smote NC

```{r}
# Train/test data -----------

set.seed(123)

srag_split <- initial_split(
  data_categorico, 
  prob = 0.7
)

srag_train <- training(srag_split)

srag_test <- testing(srag_split)

# Recipe  -----------------
lr_rec <- recipe(classi_fin ~ ., data = srag_train) %>% 
  step_normalize(idade) %>%
  themis::step_smotenc(classi_fin,seed = 69) %>% 
  step_dummy(all_nominal(), -classi_fin)  

# Specification -----------------

lr_spec <- logistic_reg() %>%
  set_mode("classification") %>%
  set_engine("glm")

# Cross-validation --------

set.seed(456)

srag_folds <- vfold_cv(srag_train, v = 10)

# grid <- grid_regular(
#   penalty(range = c(-4, -1)),
#   levels = 20
# )

# Workflow ----------------

lr_wf <- workflow() %>%
  add_model(lr_spec) %>%
  add_recipe(lr_rec)

# Resamples ---------------

lr_metrics <- metric_set(roc_auc, sensitivity, specificity, ppv, npv)


lr_res <- lr_wf %>% 
  fit_resamples(
    resamples = srag_folds,
    metrics = lr_metrics,
    control = control_resamples(save_pred = TRUE)
) 

# metrics

collect_metrics(lr_res)

# best auc

best_auc <- select_best(lr_res, "roc_auc")

# Final fit model ---------

lr_final <- finalize_workflow(
  lr_wf,
  best_auc
)

final_fit <- last_fit(
  lr_final, 
  srag_split,
)

# confusion matrix

conf_mat(
  data = final_fit$.predictions[[1]],
  truth = classi_fin,
  estimate = .pred_class
) %>% 
  autoplot(type = "heatmap")

# Predictions -------------

preds <- final_fit %>% 
  collect_predictions()

# performance

summary(conf_mat(preds, classi_fin, .pred_class)) %>%
  dplyr::select(-.estimator) %>%
  gt() %>% 
  fmt_number(columns = 2, decimals = 4)


```


### Adasyn distancia HEOM

```{r}
# treino e teste

set.seed(123)

srag_split <- initial_split(
  data_categorico2, 
  prob = 0.7
)

srag_train <- training(srag_split)


srag_test <- testing(srag_split)

### 

### Reamostragem 

set.seed(69)

srag_train <-  AdasynClassif(classi_fin ~., srag_train,dist="HEOM")

# Recipe  -----------------
lr_rec <- recipe(classi_fin ~ ., data = srag_train) %>% 
  step_normalize(idade) #%>%
  #step_dummy(all_nominal(), -classi_fin)  

# Specification -----------------

lr_spec <- logistic_reg() %>%
  set_mode("classification") %>%
  set_engine("glm")

# Cross-validation --------

set.seed(456)

srag_folds <- vfold_cv(srag_train, v = 10)

# grid <- grid_regular(
#   penalty(range = c(-4, -1)),
#   levels = 20
# )

# Workflow ----------------

lr_wf <- workflow() %>%
  add_model(lr_spec) %>%
  add_recipe(lr_rec)

# Resamples ---------------

lr_metrics <- metric_set(roc_auc, sensitivity, specificity, ppv, npv)


lr_res <- lr_wf %>% 
  fit_resamples(
    resamples = srag_folds,
    metrics = lr_metrics,
    control = control_resamples(save_pred = TRUE)
) 

# metrics

collect_metrics(lr_res)

# best auc

best_auc <- select_best(lr_res, "roc_auc")

# Final fit model ---------

lr_final <- finalize_workflow(
  lr_wf,
  best_auc
)

# final_fit <- last_fit(
#   lr_final, 
#   srag_split,
# )


final_fit <- lr_final %>% fit(srag_train)

srag_test$`.pred_class` <- predict(final_fit,srag_test)[[1]]

# confusion matrix

conf_mat(
  data = srag_test,
  truth = classi_fin,
  estimate = .pred_class
) %>% 
  autoplot(type = "heatmap")

# # Predictions -------------
# 
# preds <- final_fit %>% 
#   collect_predictions()

# performance

summary(conf_mat(srag_test, classi_fin, .pred_class)) %>%
  dplyr::select(-.estimator) %>%
  gt() %>% 
  fmt_number(columns = 2, decimals = 4)

```


### Smote distencia HEOM

```{r}
# treino e teste

set.seed(123)

srag_split <- initial_split(
  data_categorico2, 
  prob = 0.7
)

srag_train <- training(srag_split)


srag_test <- testing(srag_split)

### 

### Reamostragem 

set.seed(69)

srag_train <-  SmoteClassif(classi_fin ~., srag_train,dist="HEOM")

# Recipe  -----------------
lr_rec <- recipe(classi_fin ~ ., data = srag_train) %>% 
  step_normalize(idade) #%>%
  #step_dummy(all_nominal(), -classi_fin)  

# Specification -----------------

lr_spec <- logistic_reg() %>%
  set_mode("classification") %>%
  set_engine("glm")

# Cross-validation --------

set.seed(456)

srag_folds <- vfold_cv(srag_train, v = 10)

# grid <- grid_regular(
#   penalty(range = c(-4, -1)),
#   levels = 20
# )

# Workflow ----------------

lr_wf <- workflow() %>%
  add_model(lr_spec) %>%
  add_recipe(lr_rec)

# Resamples ---------------

lr_metrics <- metric_set(roc_auc, sensitivity, specificity, ppv, npv)


lr_res <- lr_wf %>% 
  fit_resamples(
    resamples = srag_folds,
    metrics = lr_metrics,
    control = control_resamples(save_pred = TRUE)
) 

# metrics

collect_metrics(lr_res)

# best auc

best_auc <- select_best(lr_res, "roc_auc")

# Final fit model ---------

lr_final <- finalize_workflow(
  lr_wf,
  best_auc
)

final_fit <- lr_final %>% fit(srag_train)

srag_test$`.pred_class` <- predict(final_fit,srag_test)[[1]]

# confusion matrix

conf_mat(
  data = srag_test,
  truth = classi_fin,
  estimate = .pred_class
) %>% 
  autoplot(type = "heatmap")

# performance

summary(conf_mat(srag_test, classi_fin, .pred_class)) %>%
  dplyr::select(-.estimator) %>%
  gt() %>% 
  fmt_number(columns = 2, decimals = 4)
```


### Links de tomek distancia HEOM

```{r}
# treino e teste

set.seed(123)

srag_split <- initial_split(
  data_categorico2, 
  prob = 0.7
)

srag_train <- training(srag_split)


srag_test <- testing(srag_split)


### Reamostragem 

set.seed(69)

srag_train <-  TomekClassif(classi_fin ~., srag_train,rem="maj",dist="HEOM")[[1]]

# Recipe  -----------------
lr_rec <- recipe(classi_fin ~ ., data = srag_train) %>% 
  step_normalize(idade) #%>%
  #step_dummy(all_nominal(), -classi_fin)  

# Specification -----------------

lr_spec <- logistic_reg() %>%
  set_mode("classification") %>%
  set_engine("glm")

# Cross-validation --------

set.seed(456)

credit_folds <- vfold_cv(srag_train, v = 10)

# grid <- grid_regular(
#   penalty(range = c(-4, -1)),
#   levels = 20
# )

# Workflow ----------------

lr_wf <- workflow() %>%
  add_model(lr_spec) %>%
  add_recipe(lr_rec)

# Resamples ---------------

lr_metrics <- metric_set(roc_auc, sensitivity, specificity, ppv, npv)


lr_res <- lr_wf %>% 
  fit_resamples(
    resamples = srag_folds,
    metrics = lr_metrics,
    control = control_resamples(save_pred = TRUE)
) 

# metrics

collect_metrics(lr_res)

# best auc

best_auc <- select_best(lr_res, "roc_auc")

# Final fit model ---------

lr_final <- finalize_workflow(
  lr_wf,
  best_auc
)

final_fit <- lr_final %>% fit(srag_train)

srag_test$`.pred_class` <- predict(final_fit,srag_test)[[1]]

# confusion matrix

conf_mat(
  data = srag_test,
  truth = classi_fin,
  estimate = .pred_class
) %>% 
  autoplot(type = "heatmap")

# Predictions -------------

# preds <- final_fit %>% 
#   collect_predictions()

# performance

summary(conf_mat(srag_test, classi_fin, .pred_class)) %>%
  dplyr::select(-.estimator) %>%
  gt() %>% 
  fmt_number(columns = 2, decimals = 4)

```



## Reamostragem com dados numéricos e categóricos com aplicação do modelo XGBoost

### Smote NC

```{r}
# Train/test data -----------

set.seed(123)

srag_split <- initial_split(
  data_categorico, 
  prob = 0.7
)

srag_train <- training(srag_split)

srag_test <- testing(srag_split)

xgb_rec <- recipe(classi_fin ~ ., data = srag_train) %>% 
  step_normalize(idade) %>%
  themis::step_smotenc(classi_fin,seed = 69) %>% 
  step_dummy(all_nominal(), -classi_fin)  
   #%>% 
# prep()

xgb_spec <- boost_tree(
  trees = 1000,
  tree_depth = tune(), min_n = tune(), 
  loss_reduction = tune(),                     ## first three: model complexity
  sample_size = tune(), mtry = tune(),         ## randomness
  learn_rate = tune(),                         ## step size
) %>% 
  set_engine("xgboost") %>% 
  set_mode("classification")

# Grid search --------------

xgb_grid <- grid_max_entropy(
  tree_depth(),
  min_n(),
  loss_reduction(),
  sample_size = sample_prop(),
  finalize(mtry(), srag_train),
  learn_rate(),
  size = 30
)


# Workflow ----------------

xgb_wf <- workflow() %>%
  add_recipe(xgb_rec) %>%
  add_model(xgb_spec) #%>% 
#fit(srag_train)

# Cross-validation --------

set.seed(456)

srag_folds <- vfold_cv(
  srag_train, 
  v = 10
)   

# Tuning ------------------

xgb_metrics <- metric_set(roc_auc, sensitivity, specificity, npv, ppv)

doParallel::registerDoParallel()

set.seed(1011)

xgb_res <- readRDS("tunning_smotenc_monografia.rds")
# xgb_res <- 
#   xgb_wf %>% 
#   tune_grid(
#     resamples = srag_folds,
#     grid = xgb_grid,
#     metrics = xgb_metrics,
#     control = control_grid(save_pred = TRUE)
#   )
# 
# 
# 
# saveRDS(xgb_res,"tunning_smotenc_monografia.rds")

# metrics

#collect_metrics(xgb_res)

# best hyperparameters

#show_best(xgb_res, "roc_auc")

# best auc

best_auc <- select_best(xgb_res, "roc_auc") 

# Best model --------------

final_xgb <- finalize_workflow(
  xgb_wf,
  best_auc
)

# Final fit model ---------

final_fit <- last_fit(
  final_xgb, 
  srag_split,
)

#collect_metrics(final_fit)

# ### Gráfico de pontos
# final_xgb %>%
#   fit(data = srag_train) %>%
#   extract_fit_parsnip() %>%
#   vip(geom = "point")
# 
# #### Variáveis importantes
# final_fit %>%  
#   pluck(".workflow",1) %>% 
#   extract_fit_parsnip() %>% 
#   vip::vip(num_features=20)

# Matriz de confusão

conf_mat(
  data = final_fit$.predictions[[1]],
  truth = classi_fin,
  estimate = .pred_class
) %>% 
  autoplot(type = "heatmap")

preds <- final_fit %>% 
  collect_predictions() 

summary(conf_mat(preds, classi_fin, .pred_class)) %>%
  dplyr::select(-.estimator) %>%
  gt() %>% 
  fmt_number(columns = 2, decimals = 4)

```

### Adasyn distancia HEOM

```{r}
# treino e teste

set.seed(123)

srag_split <- initial_split(
  data_categorico2, 
  prob = 0.7
)

srag_train <- training(srag_split)


srag_test <- testing(srag_split)


### Reamostragem 

set.seed(69)

srag_train <-  AdasynClassif(classi_fin ~., srag_train,dist="HEOM")

# Recipe  -----------------
xgb_rec <- recipe(classi_fin ~ ., data = srag_train) %>% 
  step_normalize(idade) %>%
  step_dummy(all_nominal(), -classi_fin)  

# Specification -----------------

xgb_spec <- boost_tree(
  trees = 1000,
  tree_depth = tune(), min_n = tune(), 
  loss_reduction = tune(),                     ## first three: model complexity
  sample_size = tune(), mtry = tune(),         ## randomness
  learn_rate = tune(),                         ## step size
) %>% 
  set_engine("xgboost") %>% 
  set_mode("classification")

# Grid search --------------

xgb_grid <- grid_max_entropy(
  tree_depth(),
  min_n(),
  loss_reduction(),
  sample_size = sample_prop(),
  finalize(mtry(), srag_train),
  learn_rate(),
  size = 30
)


# Workflow ----------------

xgb_wf <- workflow() %>%
  add_recipe(xgb_rec) %>%
  add_model(xgb_spec) #%>% 
#fit(srag_train)

# Cross-validation --------

set.seed(456)

srag_folds <- vfold_cv(
  srag_train, 
  v = 10
)   

# Tuning ------------------

xgb_metrics <- metric_set(roc_auc, sensitivity, specificity, npv, ppv)

doParallel::registerDoParallel()

set.seed(1011)

# xgb_res <- 
#   xgb_wf %>% 
#   tune_grid(
#     resamples = srag_folds,
#     grid = xgb_grid,
#     metrics = xgb_metrics,
#     control = control_grid(save_pred = TRUE)
#   )



xgb_res <- readRDS("tunning_adasynheom_monografia.rds")

# metrics

#collect_metrics(xgb_res)

# best hyperparameters

#show_best(xgb_res, "roc_auc")

# best auc

best_auc <- select_best(xgb_res, "roc_auc")

# Best model --------------

final_xgb <- finalize_workflow(
  xgb_wf,
  best_auc
)

# final_fit <- last_fit(
#   lr_final, 
#   srag_split,
# )


final_fit <- final_xgb %>% fit(srag_train)

srag_test$`.pred_class` <- predict(final_fit,srag_test)[[1]]



# confusion matrix

conf_mat(
  data = srag_test,
  truth = classi_fin,
  estimate = .pred_class
) %>% 
  autoplot(type = "heatmap")

# # Predictions -------------
# 
# preds <- final_fit %>% 
#   collect_predictions()

# performance

summary(conf_mat(srag_test, classi_fin, .pred_class)) %>%
  dplyr::select(-.estimator) %>%
  gt() %>% 
  fmt_number(columns = 2, decimals = 4)

```

### Smote distancia HEOM

```{r}
# treino e teste

set.seed(123)

srag_split <- initial_split(
  data_categorico2, 
  prob = 0.7
)

srag_train <- training(srag_split)


srag_test <- testing(srag_split)


### Reamostragem 

set.seed(69)

srag_train <-  SmoteClassif(classi_fin ~., srag_train,dist="HEOM")

# Recipe  -----------------
xgb_rec <- recipe(classi_fin ~ ., data = srag_train) %>% 
  step_normalize(idade) %>%
  step_dummy(all_nominal(), -classi_fin)  

# Specification -----------------

xgb_spec <- boost_tree(
  trees = 1000,
  tree_depth = tune(), min_n = tune(), 
  loss_reduction = tune(),                     ## first three: model complexity
  sample_size = tune(), mtry = tune(),         ## randomness
  learn_rate = tune(),                         ## step size
) %>% 
  set_engine("xgboost") %>% 
  set_mode("classification")

# Grid search --------------

xgb_grid <- grid_max_entropy(
  tree_depth(),
  min_n(),
  loss_reduction(),
  sample_size = sample_prop(),
  finalize(mtry(), srag_train),
  learn_rate(),
  size = 30
)


# Workflow ----------------

xgb_wf <- workflow() %>%
  add_recipe(xgb_rec) %>%
  add_model(xgb_spec) #%>% 
#fit(srag_train)

# Cross-validation --------

set.seed(456)

srag_folds <- vfold_cv(
  srag_train, 
  v = 10
)   

# Tuning ------------------

xgb_metrics <- metric_set(roc_auc, sensitivity, specificity, npv, ppv)

doParallel::registerDoParallel()

set.seed(1011)

# xgb_res <- 
#   xgb_wf %>% 
#   tune_grid(
#     resamples = srag_folds,
#     grid = xgb_grid,
#     metrics = xgb_metrics,
#     control = control_grid(save_pred = TRUE)
#   )


xgb_res <-  readRDS("tunning_smoteheom_monografia.rds")

# metrics

#collect_metrics(xgb_res)

# best hyperparameters

#show_best(xgb_res, "roc_auc")

# best auc

best_auc <- select_best(xgb_res, "roc_auc") 

# Best model --------------

final_xgb <- finalize_workflow(
  xgb_wf,
  best_auc
)

final_fit <- final_xgb %>% fit(srag_train)

srag_test$`.pred_class` <- predict(final_fit,srag_test)[[1]]


# confusion matrix

conf_mat(
  data = srag_test,
  truth = classi_fin,
  estimate = .pred_class
) %>% 
  autoplot(type = "heatmap")

# performance

summary(conf_mat(srag_test, classi_fin, .pred_class)) %>%
  dplyr::select(-.estimator) %>%
  gt() %>% 
  fmt_number(columns = 2, decimals = 4)
```

### Links de tomek distancia HEOM

```{r}
# treino e teste

set.seed(123)

srag_split <- initial_split(
  data_categorico2, 
  prob = 0.7
)

srag_train <- training(srag_split)


srag_test <- testing(srag_split)


### Reamostragem 

set.seed(69)

srag_train <-  TomekClassif(classi_fin ~., srag_train,rem="maj",dist="HEOM")[[1]]

# Recipe  -----------------
xgb_rec <- recipe(classi_fin ~ ., data = srag_train) %>% 
  step_normalize(idade) %>%
  step_dummy(all_nominal(), -classi_fin)  

# Specification -----------------

xgb_spec <- boost_tree(
  trees = 1000,
  tree_depth = tune(), min_n = tune(), 
  loss_reduction = tune(),                     ## first three: model complexity
  sample_size = tune(), mtry = tune(),         ## randomness
  learn_rate = tune(),                         ## step size
) %>% 
  set_engine("xgboost") %>% 
  set_mode("classification")

# Grid search --------------

xgb_grid <- grid_max_entropy(
  tree_depth(),
  min_n(),
  loss_reduction(),
  sample_size = sample_prop(),
  finalize(mtry(), srag_train),
  learn_rate(),
  size = 30
)


# Workflow ----------------

xgb_wf <- workflow() %>%
  add_recipe(xgb_rec) %>%
  add_model(xgb_spec) #%>% 
#fit(srag_train)

# Cross-validation --------

set.seed(456)

srag_folds <- vfold_cv(
  srag_train, 
  v = 10
)   

# Tuning ------------------

xgb_metrics <- metric_set(roc_auc, sensitivity, specificity, npv, ppv)

doParallel::registerDoParallel()

set.seed(1011)

# xgb_res <- 
#   xgb_wf %>% 
#   tune_grid(
#     resamples = srag_folds,
#     grid = xgb_grid,
#     metrics = xgb_metrics,
#     control = control_grid(save_pred = TRUE)
#   )



xgb_res <- readRDS("tunning_tomekheom_monografia.rds")

# metrics

#collect_metrics(xgb_res)

# best hyperparameters

#show_best(xgb_res, "roc_auc")

# best auc

best_auc <- select_best(xgb_res, "roc_auc")

# Best model --------------

final_xgb <- finalize_workflow(
  xgb_wf,
  best_auc
)

final_fit <- final_xgb %>% fit(srag_train)

srag_test$`.pred_class` <- predict(final_fit,srag_test)[[1]]

# confusion matrix

conf_mat(
  data = srag_test,
  truth = classi_fin,
  estimate = .pred_class
) %>% 
  autoplot(type = "heatmap")

# Predictions -------------

# preds <- final_fit %>% 
#   collect_predictions()

# performance

summary(conf_mat(srag_test, classi_fin, .pred_class)) %>%
  dplyr::select(-.estimator) %>%
  gt() %>% 
  fmt_number(columns = 2, decimals = 4)

```



## Estudos de simulação

```{r}
data3 %>%
  #filter(classi_fin == "Não COVID-19") %>%
  ggplot(aes(idade)) +
  geom_histogram(color="pink", breaks = seq(from=10,to=55,by=2)) + #scale_colour_viridis_d(option = "turbo") +
  xlab("idade") + ylab("frequência absoluta")
  # ylab("Taxas de casos") + labs(col = "câncer") +
  #theme(axis.text.x = element_text(angle = 45)) #+
  # scale_x_date(labels = date_format("%h %y"),
  #              breaks = seq(
  #                from = min(data3$dt_sint),
  #                to = max(data3$dt_sint),
  #                by = "month"
  #              ))

datasummary1
```

```{r}
data_categorico

#"raca"         "escolaridade" "vacina"       "febre"       
#  "tosse"        "garganta"     "dispneia"     "desc_resp"    "saturacao"   
# "diarreia"     "cardiopatia"  "pneumopatia"  "renal"        "obesidade" 


with(data_categorico,ctable(raca,classi_fin))$proportions[1:4,1]
with(data_categorico,ctable(escolaridade,classi_fin))$proportions[1:5,1]
with(data_categorico,ctable(vacina,classi_fin))$proportions[1:4,1]
with(data_categorico,ctable(febre,classi_fin))$proportions[1:4,1]
with(data_categorico,ctable(tosse,classi_fin))$proportions[1:4,1]
with(data_categorico,ctable(garganta,classi_fin))$proportions[1:4,1]
with(data_categorico,ctable(dispneia,classi_fin))$proportions[1:4,1]
with(data_categorico,ctable(desc_resp,classi_fin))$proportions[1:4,1]
with(data_categorico,ctable(saturacao,classi_fin))$proportions[1:4,1]
with(data_categorico,ctable(diarreia,classi_fin))$proportions[1:4,1]
with(data_categorico,ctable(cardiopatia,classi_fin))$proportions[1:4,1]
with(data_categorico,ctable(pneumopatia,classi_fin))$proportions[1:4,1]
with(data_categorico,ctable(renal,classi_fin))$proportions[1:4,1]
with(data_categorico,ctable(obesidade,classi_fin))$proportions[1:4,1]
```



